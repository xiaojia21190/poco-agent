services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-poco}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-poco}",
        ]
      interval: 5s
      timeout: 3s
      retries: 20

  # NOTE: rustfs is expected to be S3-compatible.
  # Default image is rustfs/rustfs:latest; override RUSTFS_IMAGE / RUSTFS_DATA_DIR if needed.
  rustfs:
    image: ${RUSTFS_IMAGE:-rustfs/rustfs:latest}
    restart: unless-stopped
    environment:
      # Keep these generic; rustfs may read its own vars, but setting AWS-standard ones
      # keeps it compatible with most S3-compatible server configs.
      AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY:-poco}
      AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY:-poco-secret}
      RUSTFS_ACCESS_KEY: ${S3_ACCESS_KEY:-poco}
      RUSTFS_SECRET_KEY: ${S3_SECRET_KEY:-poco-secret}
    ports:
      - "${S3_PORT:-9000}:9000"
      - "${S3_CONSOLE_PORT:-9001}:9001"
    volumes:
      - ${RUSTFS_DATA_DIR:-./oss_data}:/data

  rustfs-init:
    image: ${RUSTFS_INIT_IMAGE:-minio/mc:latest}
    profiles: ["init"]
    depends_on:
      - rustfs
    environment:
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-poco}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-poco-secret}
      S3_BUCKET: ${S3_BUCKET:-poco}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        until mc alias set rustfs http://rustfs:9000 "$$S3_ACCESS_KEY" "$$S3_SECRET_KEY"; do
          sleep 2
        done
        mc mb -p "rustfs/$$S3_BUCKET" || true

  backend:
    # Default to pulling from GHCR; override via BACKEND_IMAGE if needed.
    image: ${BACKEND_IMAGE:-ghcr.io/poco-ai/poco-backend:latest}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_started
    environment:
      HOST: 0.0.0.0
      PORT: 8000
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}

      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-poco}
      CORS_ORIGINS: ${CORS_ORIGINS:-["http://localhost:3000","http://127.0.0.1:3000"]}
      SECRET_KEY: ${BACKEND_SECRET_KEY:-change-this-secret-key-in-production}
      INTERNAL_API_TOKEN: ${INTERNAL_API_TOKEN:-change-this-token-in-production}
      EXECUTOR_MANAGER_URL: http://executor-manager:8001

      S3_ENDPOINT: ${S3_ENDPOINT:-http://rustfs:9000}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT:-http://localhost:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-poco}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-poco-secret}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-poco}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      S3_PRESIGN_EXPIRES: ${S3_PRESIGN_EXPIRES:-300}

      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-https://api.anthropic.com}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-claude-sonnet-4-20250514}
      MODEL_LIST: ${MODEL_LIST:-[]}
      MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-100}

      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_TO_FILE: ${LOG_TO_FILE:-false}
      LOG_DIR: ${LOG_DIR:-./logs}
      LOG_BACKUP_COUNT: ${LOG_BACKUP_COUNT:-14}
      LOG_SQL: ${LOG_SQL:-false}
      UVICORN_ACCESS_LOG: ${UVICORN_ACCESS_LOG:-false}
    ports:
      - "${BACKEND_PORT:-8000}:8000"

  executor-manager:
    # Default to pulling from GHCR; override via EXECUTOR_MANAGER_IMAGE if needed.
    image: ${EXECUTOR_MANAGER_IMAGE:-ghcr.io/poco-ai/poco-executor-manager:latest}
    restart: unless-stopped
    user: "${EXECUTOR_UID:-1000}:${EXECUTOR_GID:-1000}"
    depends_on:
      backend:
        condition: service_started
      rustfs:
        condition: service_started
    environment:
      HOST: 0.0.0.0
      PORT: 8001

      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
      # Must be reachable from *executor containers* spawned by the manager.
      CALLBACK_BASE_URL: ${CALLBACK_BASE_URL:-http://host.docker.internal:8001}
      CALLBACK_TOKEN: ${CALLBACK_TOKEN:-change-this-token-in-production}
      INTERNAL_API_TOKEN: ${INTERNAL_API_TOKEN:-change-this-token-in-production}

      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-https://api.anthropic.com}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-claude-sonnet-4-20250514}

      # Image used by the manager to spawn executor containers via docker.sock.
      EXECUTOR_IMAGE: ${EXECUTOR_IMAGE:-ghcr.io/poco-ai/poco-executor:lite}
      # Optional: executor image with desktop/browser stack (used when browser_enabled=true).
      EXECUTOR_BROWSER_IMAGE: ${EXECUTOR_BROWSER_IMAGE:-ghcr.io/poco-ai/poco-executor:full}
      # Default desktop viewport for browser-enabled runs (Playwright MCP).
      POCO_BROWSER_VIEWPORT_SIZE: ${POCO_BROWSER_VIEWPORT_SIZE:-1366x768}
      # Manager accesses executor containers through published host ports.
      EXECUTOR_PUBLISHED_HOST: ${EXECUTOR_PUBLISHED_HOST:-host.docker.internal}

      WORKSPACE_ROOT: ${PWD}/tmp_workspace

      MAX_CONCURRENT_TASKS: ${MAX_CONCURRENT_TASKS:-5}
      TASK_PULL_ENABLED: ${TASK_PULL_ENABLED:-true}
      TASK_PULL_INTERVAL_SECONDS: ${TASK_PULL_INTERVAL_SECONDS:-2}
      TASK_CLAIM_LEASE_SECONDS: ${TASK_CLAIM_LEASE_SECONDS:-180}

      WORKSPACE_CLEANUP_ENABLED: ${WORKSPACE_CLEANUP_ENABLED:-false}
      WORKSPACE_ARCHIVE_ENABLED: ${WORKSPACE_ARCHIVE_ENABLED:-true}
      WORKSPACE_ARCHIVE_DAYS: ${WORKSPACE_ARCHIVE_DAYS:-7}
      WORKSPACE_IGNORE_DOT_FILES: ${WORKSPACE_IGNORE_DOT_FILES:-true}

      S3_ENDPOINT: ${S3_ENDPOINT:-http://rustfs:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-poco}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-poco-secret}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-poco}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}

      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_TO_FILE: ${LOG_TO_FILE:-false}
      LOG_DIR: ${LOG_DIR:-./logs}
      LOG_BACKUP_COUNT: ${LOG_BACKUP_COUNT:-14}
      UVICORN_ACCESS_LOG: ${UVICORN_ACCESS_LOG:-false}
    # Allow the non-root "app" user (APP_UID) to access the host Docker socket.
    # On Linux the socket is usually `root:<docker_gid>` with mode 660.
    group_add:
      - "${DOCKER_GID:-0}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./tmp_workspace:${PWD}/tmp_workspace
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "${EXECUTOR_MANAGER_PORT:-8001}:8001"

  frontend:
    # Default to pulling from GHCR; override via FRONTEND_IMAGE if needed.
    image: ${FRONTEND_IMAGE:-ghcr.io/poco-ai/poco-frontend:latest}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    environment:
      # Runtime backend URL for the Next.js API proxy (/api/v1/* -> backend).
      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"

  im:
    profiles: ["im"]
    # Default to pulling from GHCR; override via IM_IMAGE if needed.
    image: ${IM_IMAGE:-ghcr.io/poco-ai/poco-im:latest}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    environment:
      DATABASE_URL: ${IM_DATABASE_URL:-sqlite:///./im.db}
      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
      BACKEND_USER_ID: ${BACKEND_USER_ID:-default}
      FRONTEND_PUBLIC_URL: ${FRONTEND_PUBLIC_URL:-http://localhost:3000}
      FRONTEND_DEFAULT_LANG: ${FRONTEND_DEFAULT_LANG:-zh}

      POLL_USER_INPUT_INTERVAL_SECONDS: ${POLL_USER_INPUT_INTERVAL_SECONDS:-2}
      POLL_SESSIONS_RECENT_INTERVAL_SECONDS: ${POLL_SESSIONS_RECENT_INTERVAL_SECONDS:-5}
      POLL_SESSIONS_FULL_INTERVAL_SECONDS: ${POLL_SESSIONS_FULL_INTERVAL_SECONDS:-300}
      POLL_HTTP_TIMEOUT_SECONDS: ${POLL_HTTP_TIMEOUT_SECONDS:-10}

      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_WEBHOOK_SECRET_TOKEN: ${TELEGRAM_WEBHOOK_SECRET_TOKEN:-}

      DINGTALK_ENABLED: ${DINGTALK_ENABLED:-true}
      DINGTALK_WEBHOOK_TOKEN: ${DINGTALK_WEBHOOK_TOKEN:-}
      DINGTALK_STREAM_ENABLED: ${DINGTALK_STREAM_ENABLED:-true}
      DINGTALK_STREAM_SUBSCRIBE_EVENTS: ${DINGTALK_STREAM_SUBSCRIBE_EVENTS:-false}
      DINGTALK_CLIENT_ID: ${DINGTALK_CLIENT_ID:-}
      DINGTALK_CLIENT_SECRET: ${DINGTALK_CLIENT_SECRET:-}
      DINGTALK_ROBOT_CODE: ${DINGTALK_ROBOT_CODE:-}
      DINGTALK_OPEN_BASE_URL: ${DINGTALK_OPEN_BASE_URL:-https://api.dingtalk.com}
      DINGTALK_WEBHOOK_URL: ${DINGTALK_WEBHOOK_URL:-}

    ports:
      - "8002:8002"

volumes:
  postgres_data:
